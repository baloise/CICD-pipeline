name: CI

on:
   push:
     branches:
       - '**'

jobs:
   build:
     runs-on: ubuntu-latest
     steps:
       - name: Checkout
         uses: actions/checkout@master
       - uses: actions/cache@v1
         with:
           path: ~/.m2/repository
           key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
           restore-keys: |
             ${{ runner.os }}-maven-
       - name: Build with Maven
         run: mvn --no-transfer-progress clean test
       - name: Extract branch name
         shell: bash
         run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
         id: extract_branch
       - name: copy badge
         run: |
           mv target/site/linecoverage.svg  /tmp
       - uses: actions/checkout@master
         with:
           ref: 'badges'
       - name: Commit badge
         env:
           BRANCH: ${{ steps.extract_branch.outputs.branch }}
         run: |
           git config --local user.email "action@github.com"
           git config --local user.name "GitHub Action"
           mkdir -p "${BRANCH}"
           mv /tmp/linecoverage.svg "${BRANCH}"
           git add "${BRANCH}/linecoverage.svg"
           git commit -m "Add/Update badge"
       - name: Push badge commit
         uses: ad-m/github-push-action@master
         with:
           github_token: ${{ secrets.GITHUB_TOKEN }}
           branch: badges
